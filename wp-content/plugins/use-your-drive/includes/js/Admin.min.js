(function(e){function t(e){e.origin===window.parent.location.origin&&"object"==typeof e.data&&null!==e.data&&void 0!==e.data.action&&"wpcp-change-value"===e.data.action&&a(e.data.id,e.data.value,e.data.oldvalue)}function a(t,a,n){window.hideNotifications(),i(),e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-save-setting",key:t,value:a,network:s.is_network,_ajax_nonce:s.admin_nonce},success:function(a){e.each(a,function(e,a){t!==e&&o(e,a),"reload"===e&&!0===a&&window.location.reload()}),window.showNotification(!0)},error:function(){o(t,n),window.showNotification(!1)},dataType:"json"}),e.ajaxQueue.run()}function o(t,a){var o=e("#"+t);"text"===o.attr("type")||o.is("textarea")?o.val(a):"checkbox"===o.attr("type")?o.prop("checked","Yes"===a).trigger("change"):o.is("select")?o.val(a):"text"===o.attr("type")&&o.val(a).trigger("change")}function n(t,a){var o=e('.wpcp-license[data-license-code="'+t+'"]');e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-license",license_code:t,type:a,_ajax_nonce:s.admin_nonce},success:function(t){"deactivate"===a&&window.location.reload(),!1===t.valid?(void 0!==t.error_message?e(".purchase-input-error-message").html(t.error_message):e(".purchase-input-error-message").html("Cannot validate the License. Check the code or try to activate via Envato Market.<br/> <small>Check <strong>[Tools] -> [Site Health]</strong> for communication problems if the problem persists.</small>"),e("#wpcp-modal-activation").fadeIn(),e(".purchase-input-error").fadeIn()):"activate"===a?window.location.reload():(void 0!==t.data.item&&(o.find(".wpcp-license-icon").attr("src",t.data.item.previews.icon_preview.icon_url),o.find(".wpcp-license-buyer").text(t.data.buyer),o.find(".wpcp-license-buyer").attr("href","https://themeforest.net/user/"+t.data.buyer),o.find(".wpcp-license-type").text(t.data.license),o.find(".wpcp-license-support").text(t.supported_until_str),!1===t.support_package&&o.find(".wpcp-license-error").slideDown().find(".wpcp-license-error-message").text(t.error_message)),o.find(".wpcp-license-details").slideDown())},error:function(t){e(".purchase-input-error-message").html("Cannot validate the License. Check the code or try to activate via Envato Market.<br/> <small>Check <strong>[Tools] -> [Site Health]</strong> for communication problems if the problem persists.</small>"),e("#wpcp-modal-activation").fadeIn(),e(".purchase-input-error").fadeIn(),e(this).parents(".wpcp-license").slideDown()},dataType:"json"})}function i(){for(var e=localStorage.length;e--;){var t=localStorage.key(e);/wpcp/.test(t)&&localStorage.removeItem(t)}}var c,r,s=UseyourDrive_Admin_vars;e(".wpcp-color-picker").wpColorPicker({change:function(t,a){c&&clearTimeout(c),c=setTimeout(function(t){e(t).trigger("change")},500,t.target)}}),e(".wpcp-image-selector-button").on("click",function(t){var a=e(this).parent().parent().find("input");r=wp.media.frames.file_frame=wp.media({title:"Select your image",button:{text:"Use this Image"},multiple:!1}),r.on("select",function(){var e=r.state().get("selection").first().toJSON(),t=e.mime,o=/^image\/(?:jpe?g|png|gif|svg)$/i,n=t.match(o);n&&(a.val(e.url),a.trigger("change"))}),r.open()}),e(".wpcp-image-selector-default-button").on("click",function(t){var a=e(this).parent().parent().find("input");a.val(e(this).attr("data-default")).trigger("change")}),e(".wpcp-image-selector-input").on("change",function(){e(this).parent().parent().parent().find(".wpcp-image-selector-preview").attr("src",e(this).val())}),window.addEventListener("message",t),e(".wpcp-delete-account-button, .wpcp-refresh-account-button").hide(),e(".wpcp-account").each(function(){var t=e(this),a=t.data("account-id");e.ajax({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-check-account",account_id:a,_ajax_nonce:s.admin_nonce},success:function(e){!1!==e.has_token&&!1!==e.is_authorized||(t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),""!==e.quota_used?(t.find(".wpcp-account-storage-information").text(e.quota_used+"/"+e.quota_total),t.find(".wpcp-account-storage-information-bar").width(e.quota_used_percentage+"%"),0===e.quota_used_percentage&&t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()):(t.find(".wpcp-account-storage-information").parent().fadeOut(),t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()),""!==e.error_message&&(t.find(".wpcp-account-error-message").text(e.error_message),t.find(".wpcp-account-error-details").html(e.error_details),t.find(".wpcp-account-error").fadeIn())},error:function(e){void 0!==e.has_token?(!1!==e.has_token&&!1!==e.is_authorized||(t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),""!==e.quota_used?(t.find(".wpcp-account-storage-information").text(e.quota_used+"/"+e.quota_total),t.find(".wpcp-account-storage-information-bar").width(e.quota_used_percentage+"%")):(t.find(".wpcp-account-storage-information").parent().fadeOut(),t.find(".wpcp-account-storage-information-bar").parent().parent().fadeOut()),""!==e.error_message&&(t.find(".wpcp-account-error-message").text(e.error_message),t.find(".wpcp-account-error-details").html(e.error_details))):(t.find(".wpcp-account-error-message").text("Could not receive account information. Try to refresh the page or relink your account."),t.find(".wpcp-revoke-account-button").hide(),t.find(".wpcp-refresh-account-button, .wpcp-delete-account-button").show()),t.find(".wpcp-account-error").fadeIn()},dataType:"json"})}),e("#wpcp-add-account-button").on("click",function(t){e(".account-dialog-step").hide(),e(".account-dialog-step:first").show(),e("#wpcp-modal-privacy-policy .wpcp-dialog-next").show(),e("#wpcp-modal-privacy-policy").fadeIn()}),e("#wpcp-read-privacy-policy").on("click",function(t){e(".account-dialog-step").hide(),e(".account-dialog-step:first").show(),e("#wpcp-modal-privacy-policy .wpcp-dialog-next").hide(),e("#wpcp-modal-privacy-policy").fadeIn()}),e("#wpcp-start-oauth-button, .wpcp-refresh-account-button").on("click",function(t){const a=680,o=1024,n=window.top.outerHeight/2+window.top.screenY-a/2,c=window.top.outerWidth/2+window.top.screenX-o/2,r="noopener, noreferrer, toolbar=yes, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width="+o+", height="+a+", top="+n+", left="+c;let s=window.open(e(this).attr("data-url"),"_blank",r);s.opener=null,i()}),e('input[name="selected-scope"]').on("change",function(t){let a=e('input[name="selected-scope"]:checked'),o=a.val(),n=a.attr("data-url");e("label[data-scope]").hide(),e('label[data-scope="'+o+'"]').show();let i=e("#wpcp-start-oauth-button");i.attr("data-url",n)}),e('input[name="selected-scope"]').trigger("change"),e(".wpcp-revoke-account-button, .wpcp-delete-account-button").on("click",function(t){var a=e(this).parents(".wpcp-account");a.slideUp(),e.ajaxQueue.addRequest({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-revoke",account_id:e(this).attr("data-account-id"),force:e(this).attr("data-force"),_ajax_nonce:s.admin_nonce},success:function(t){!0===t.success?(a.remove(),0===e("#wpcp-account-list li").length&&e("#wpcp-account-list").html(""),window.showNotification(!0)):(a.slideDown(),window.showNotification(!1))},error:function(e){a.slideDown(),window.showNotification(!1)},dataType:"json"}),e.ajaxQueue.run()}),e("#wpcp-activate-button").on("click",function(e){const t="noopener, noreferrer, toolbar=yes,scrollbars=yes,resizable=yes,width=1280,height=700";let a=window.open(s.activate_url,"_blank",t);a.opener=null}),window.addEventListener("storage",function(e){"wpcp_refreshParent"===e.key&&"true"===e.newValue&&(window.location.reload(),localStorage.removeItem("wpcp_refreshParent"))}),e("#license_code").on("change keyup paste",function(t){var a="^([a-f0-9]{8})-([a-f0-9]{4})-(4[a-f0-9]{3})-([a-f0-9]{4})-([a-f0-9]{12})$";e(this).val().match(a)?(e(this).css("color","initial"),e(".purchase-input-error").fadeOut(),e("#wpcp-license-activate").removeAttr("disabled")):(e(this).css("color","#dc3232"),e(".purchase-input-error-message").text("Expected format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"),e(".purchase-input-error").fadeIn(),e("#wpcp-license-activate").attr("disabled","disabled"))}),e("#license_code").trigger("change"),e("#wpcp-license-activate").on("click",function(t){n(e("#license_code").val(),"activate")}),e(".wpcp-license").each(function(){n(e(this).data("license-code"),"get-details")}),e("#wpcp-deactivate-license-button").on("click",function(t){e(this).parents(".wpcp-license").slideUp(),n("","deactivate")}),e("#wpcp-slack-test-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-slack-test",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),a.prop("disabled",!1).removeClass("disabled")},dataType:"json"}),i()}),e("#wpcp-reset-usage-limits-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-reset-usage-limits",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),a.prop("disabled",!1).removeClass("disabled")},dataType:"json"})}),e("#wpcp-purge-cache-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-reset-cache",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),a.prop("disabled",!1).removeClass("disabled")},dataType:"json"}),i()}),e("#wpcp-api-log-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled");var o={action:"useyourdrive-api-log",type:"download",_ajax_nonce:s.admin_nonce},n="hiddenDownloader",i=document.getElementById(n);null===i&&(i=document.createElement("iframe"),i.id=n,i.style.display="none",document.body.appendChild(i)),i.src=s.ajax_url+"?"+e.param(o),setTimeout(function(){a.prop("disabled",!1).removeClass("disabled")},5e3)}),e("#wpcp-export-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled");var o={action:"useyourdrive-backup",type:"export",_ajax_nonce:s.admin_nonce},n="hiddenDownloader",i=document.getElementById(n);null===i&&(i=document.createElement("iframe"),i.id=n,i.style.display="none",document.body.appendChild(i)),i.src=s.ajax_url+"?"+e.param(o),setTimeout(function(){a.prop("disabled",!1).removeClass("disabled")},5e3)}),e("#wpcp-import-button").on("click",function(t){let a=e(this);var o=e(this).parent(),n=o.find('[type="file"]');if(0!=n[0].files.length){a.prop("disabled",!0).addClass("disabled");var i=new FormData;i.append("tools_import_file",n[0].files[0]),e.ajax({type:"POST",url:s.ajax_url+"?action=useyourdrive-backup&type=import&_ajax_nonce="+s.admin_nonce,data:i,processData:!1,contentType:!1,success:function(e){0!==e.result?(window.showNotification(!0),location.reload()):window.showNotification(!1)},error:function(e){window.showNotification(!1)},complete:function(){a.prop("disabled",!1).removeClass("disabled")},dataType:"json"})}else window.showNotification(!1)}),e("#wpcp-factory-reset-button").on("click",function(t){let a=e(this);a.prop("disabled",!0).addClass("disabled"),e.ajax({type:"POST",url:s.ajax_url,data:{action:"useyourdrive-factory-reset",_ajax_nonce:s.admin_nonce},complete:function(e){window.showNotification(!0),location.reload()},dataType:"json"}),i()})})(jQuery);